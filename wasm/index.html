<head>
  <link rel="stylesheet" href="bulma.min.css">
  <link rel="stylesheet" href="app.css">
  <script src="https://kit.fontawesome.com/2c3ddc949d.js" crossorigin="anonymous"></script>
</head>
<body>
  <nav class="navbar is-link">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.github.com/annethereshewent"><i class="fa-brands logo fa-github"></i>RSX Emulator</a>
    </div>

    <div id="navbar-main" class="navbar-menu">
      <div class="navbar-start">
        <div class="navbar-item">
          <div class="buttons">
            <button id="bios-button" class="button is-warning">
              <i class="fa-solid fa-upload"></i>
              Load BIOS
            </button>
            <button disabled id="game-button" class="button is-primary">
              <i class="fa-solid fa-upload"></i>
              Load Game
            </button>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <button class="button is-info" onclick="displayHelpModal()">
              <i class="fa-solid fa-circle-info"></i>
              Help
            </button>
            <button class="button is-danger" onclick="enterFullscreen()">
              <i class="fa-solid fa-expand"></i>
              Full Screen
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div id="emulator">
    <input type="file" id="bios-input" class="file-input">
    <input type="file" id="game-input" class="file-input">
    <canvas width="640" height="480" id="canvas" />
  </div>
  <div id="help-modal" class="modal hide">
    <div class="modal-background" />
    <div class="modal-content">
      <div class="card">
        <header class="card-header">
          <p class="card-header-title">
            RSX Emulator Help
          </p>
        </header>
        <div class="card-content">
          <div class="content">
            <button class="modal-close" aria-label="close" onclick="hideHelpModal()">Close</button>
            <h3 class="content-title">Controls</h4>
            <h3>Keyboard:</h3>
            <ul>
              <li><label>Up:</label> W key</li>
              <li><label>Down:</label> S key</li>
              <li><label>Left:</label> A key</li>
              <li><label>Right:</label> D key</li>
              <li><label>Cross button:</label> K key</li>
              <li><label>Circle button:</label> L key</li>
              <li><label>Square button:</label> J key</li>
              <li><label>Triangle button:</label> I key</li>
              <li><label>L1 button:</label> C key</li>
              <li><label>R1 button:</label> V key</li>
              <li><label>L2 button:</label> Z key</li>
              <li><label>R2 button:</label> X key</li>
              <li><label>L3 button:</label> 1 key</li>
              <li><label>R3 button:</label> 2 key</li>
              <li><label>Select:</label> Tab</li>
              <li><label>Start:</label> Enter</li>
            </ul>
            <h3>PS5 Controller:</h3>
            <p>Same buttons as Playstation controller. Select and Start buttons are remapped to "Share" and "Options". The touchpad button switches between digital and analog mode.</p>

            <p>Emulator written by <a href="https://www.github.com/annethereshewent">annethereshewent</a></p>

          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="jszip.min.js"></script>
  <script>
    function enterFullscreen() {
      document.documentElement.requestFullscreen()
    }
    function displayHelpModal() {
      document.getElementById("help-modal").className = "modal show"
    }

    function hideHelpModal() {
      document.getElementById("help-modal").className = "modal hide"
    }
  </script>
  <script type="module">
    import init, { WasmEmulator } from "./pkg/rsx_wasm.js"

    async function main() {
      let emulator = null
      let biosData = null
      let fileName = ""
      let gameData = null

      document.getElementById("bios-button").addEventListener("click", () => document.getElementById("bios-input").click())
      document.getElementById("game-button").addEventListener("click", () => document.getElementById("game-input").click())

      document.getElementById("bios-input").addEventListener("change", handleBiosChange)
      document.getElementById("game-input").addEventListener("change", handleGameChange)

      const path = "pkg/rsx_wasm_bg.wasm"

      const wasm = await init(path)



      async function handleBiosChange(e) {
        const bios = await getBinaryData(e)

        if (bios != null) {
          biosData = new Uint8Array(bios)
          document.getElementById("game-button").removeAttribute("disabled")
        }
      }

      async function handleGameChange(e) {
        const game = await getBinaryData(e)

        if (game != null) {
          gameData = new Uint8Array(game)

          console.log(gameData)

          // finally initialize the emulator!
          emulator = new WasmEmulator(biosData, gameData)
        }
      }

      async function getBinaryData(e, setFilename) {
        let data = null
        if (e.target.files != null) {
          const file = e.target.files[0]

          if (setFilename) {
            fileName = file.name
          }
          if (file.name.indexOf(".zip") !== -1) {
            // unzip the file first
            const zipFile = await JSZip.loadAsync(file)
            const zipFileName = Object.keys(zipFile.files)[0]

            data = await zipFile?.file(zipFileName)?.async('arraybuffer')
          } else {
            data = await fileToArrayBuffer(file)
          }
        }

        return data
      }

      function fileToArrayBuffer(file){
        const fileReader = new FileReader()

        return new Promise((resolve, reject) => {
          fileReader.onload = () => resolve(fileReader.result)

          fileReader.onerror = () => {
            fileReader.abort()
            reject(new Error("Error parsing file"))
          }

          fileReader.readAsArrayBuffer(file)
        })
      }

      document.addEventListener("keydown", (e) => {
        e.preventDefault()

        switch (e.key) {
          case "Escape":
            document.getElementById("help-modal").className = "modal hide"
            break
        }
      })

    }

    main()
  </script>
</body>